@model ExpressQuiz.ViewModels.ActiveQuizViewModel

@section scripts
{
    @Scripts.Render("~/Scripts/jquery.bootpag.min.js")
    @Scripts.Render("~/bundles/expressquiz")
    @Scripts.Render("~/Scripts/pagedown/js/jquery.pagedown-bootstrap.combined.min.js")
}

@section styles
{
    @Styles.Render("~/Content/font-awesome.min.css")
    @Styles.Render("~/Scripts/pagedown/css/jquery.pagedown-bootstrap.css")

}



<div>
    <br />

    <div class="text-center">

        <button id="done" type="button" class="btn btn-lg btn-primary">Finish</button>
        <h4 id="pTimeLeft"></h4>


    </div>
    <br />
    <div class="progress">
        <div id="prgCompleted" class="progress-bar" style="width: 0%;"></div>
    </div>

    <div id="page-selection"></div>
    <div id="content">

        <h4>Question</h4>
        <textarea class="pagedown hidden"></textarea>

        <h4>Answers</h4>
        <p>
            <div id="answers" class="col-lg-10">
            </div>
        </p>

    </div>

    <br />

    <script>

        $(document).ready(function () {

            ExpressQuiz.Utils.togglePreventLeavingPage(true);

            $.ajax({
                url: "/ActiveQuiz/GetQuiz/" + "@Model.Quiz.Id",
                type: "GET",
                error: OnGetQuizError,
                success: OnGetQuizSuccess
            });

            $("#done").click(function () {
                sendResults();
            });

        });

        var runtime = undefined;
        var counter = new ExpressQuiz.CountDown({
            seconds: "@Model.EstimatedTime",
            onUpdateStatus: function (sec) {
                $("#pTimeLeft").text("Time left: " + sec);
            },
            onCounterEnd: function () {
                sendResults();
            }
        });


        function sendResults() {
            var result = {};
            result.QuizId = "@Model.Quiz.Id";
            result.Answers = runtime.getResult();
            result.EllapsedTime = counter.getRemainingTime();

            $.ajax({
                url: '/ActiveQuiz/PostResult/',
                async: false,
                type: "POST",
                data: JSON.stringify(result),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                error: OnPostResultsError,
                success: OnPostResultsSucces

        });
        }

        function OnPostResultsSucces(data, textStatus, jqXHR) {
            var url = '/QuizReview/Index/' + data;
            ExpressQuiz.Utils.togglePreventLeavingPage(false);
            window.location.href = url;
        }

        function OnPostResultsError(jqXHR, textStatus, errorThrown) {
            ExpressQuiz.Utils.togglePreventLeavingPage(false);
            location.href = "/Home/Error/?message=" + errorThrown;
        }

        function loadQuestion(question, answerId) {

            $("#answers").empty();

            for (var i = 0; i < question.Answers.length; i++) {
                var checked = answerId == question.Answers[i].Id ? "checked" : "";

                var div = $(" <div class='radio'/>");
                var label = $("<label/>");
                var input = $("<input type='radio' " + checked + " name='optionsRadios' id=" + i + " value=" + i + ">");


                label.append(input);
                label.append(question.Answers[i].Text);

                div.append(label);
                $("#answers").append(div);
            }

            $('input[type=radio][name=optionsRadios]').on('change', function () {
                var a = $('input[name=optionsRadios]:checked', '#answers').val();
                runtime.setAnswer(runtime.currentQuestionIndex, a);
                updateProgress();
            });

            $("#content").append($("<textarea class='pagedown hidden' />"));

            $("textarea.pagedown").empty();
            $("textarea.pagedown").pagedownBootstrap({
                'sanatize': true
            });
            $("#wmd-input-0").text(question.Text);
            $(".wmd-button-bar").hide();

        }



        function init(quiz) {

            runtime = new ExpressQuiz.Runtime(quiz);

            $('#page-selection').bootpag({
                total: runtime.quiz.Questions.length,
                page: 1,
                leaps: false,
                maxVisible: 10,
                next: "next",
                prev: "previous",
            });

            $('#page-selection').on("page", function (event, num) {
                var a = $('input[name=optionsRadios]:checked', '#answers').val();

                runtime.setAnswer(runtime.currentQuestionIndex, a);

                runtime.setActiveQuestion(num - 1);
                var question = runtime.getActiveQuestion(num - 1);
                loadQuestion(question, runtime.getAnswer(runtime.currentQuestionIndex));

            });

        }


        function updateProgress() {
            var value = runtime.getProgress();
            $('.progress-bar').css('width', value + '%').attr('aria-valuenow', value);
        }

       

        function OnGetQuizSuccess(data, textStatus, jqXHR) {
            init(data);
            loadQuestion(data.Questions[0]);

            $("#pTimeLeft").text("Time left: " + '@Model.EstimatedTime');
            counter.start();

        }

        function OnGetQuizError(jqXHR, textStatus, errorThrown) {

            ExpressQuiz.Utils.togglePreventLeavingPage(false);
            location.href = "/Home/Error/?message=" + errorThrown;
        }
        

    </script>

</div>
