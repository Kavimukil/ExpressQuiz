@using System.Data.Entity
@using ExpressQuiz.Extensions
@model ExpressQuiz.ViewModels.EditQuestionViewModel


    @if (Model.ModifiedByUser)
    {
        <script>
        showSavedAlert();
     </script>
    }



<div>
    <ul class="breadcrumb" style="margin-bottom: 5px;">
        <li>
            @Html.ActionLink("Quiz", "Edit", new { id = Model.Question.QuizId })
        </li>

        <li class="active">Question</li>
    </ul>
    
   
   
</div>



@using (Ajax.BeginForm("EditQuestion", "Quizzes", new AjaxOptions()
{
    UpdateTargetId = "content",
    HttpMethod = "Post",
    InsertionMode = InsertionMode.Replace,
    OnSuccess = "applyValidation"
}))
{
    <div class="form-horizontal">

        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.HiddenFor(model => model.Question.Id)
        @Html.HiddenFor(model => model.Order)
        @Html.HiddenFor(model => model.Question.QuizId)
        @Html.HiddenFor(model => model.Question.Points)
        <div class="form-group">
            @Html.LabelFor(model => model.Question.Text, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Question.Text, new { htmlAttributes = new { @class = "form-control", @rows = 5 } })
                @Html.ValidationMessageFor(model => model.Question.Text, "", new { @class = "text-danger" })
            </div>
        </div>


        <div class="form-group">
            @if (Model.Question.Quiz.IsTimeable)
            {
                @Html.LabelFor(model => model.Question.EstimatedTime, htmlAttributes: new { @class = "control-label col-md-2" });
                <div class="col-md-2">
                    @Html.EditorFor(model => model.Question.EstimatedTime, new { htmlAttributes = new { @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.Question.EstimatedTime, "", new { @class = "text-danger" })
                </div>

            }


        </div>
        
        <div class="form-group">
            @if (Model.Question.Quiz.AllowPoints)
            {
                @Html.LabelFor(model => model.Question.Points, htmlAttributes: new { @class = "control-label col-md-2" });
                <div class="col-md-2">
                    <input id="questionPoints" class="form-control" data-slider-id='ex1Slider' type="text" data-slider-min="1" data-slider-max="10"
                           data-slider-step="0.1" data-slider-value="@Model.Question.Points" />
                    
                  
                </div>

            }


        </div>

        <div class="form-group">
            <div class="col-md-offset-11 col-md-1">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </div>

        <hr />
        @Ajax.ActionLink("Add answer", "CreateAnswer", "Quizzes", new { id = Model.Question.Id, orderId = Model.Question.Answers.Count }, new AjaxOptions()
                                    {
                                        InsertionMode = InsertionMode.Replace,
                                        HttpMethod = "Get",
                                        UpdateTargetId = "content",
                                        OnSuccess = "applyValidation"

                                    }, htmlAttributes: new { @class = "btn btn-primary btn-block" })


        <table id="answersTbl" class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <td></td>
                    <td>Answer</td>
                    <td>Is correct</td>
                </tr>

            </thead>
            <tbody>
                @{

    foreach (var a in Model.Question.Answers.AsQueryable().AsNoTracking().OrderBy(x => x.OrderId))
    {

        <tr id="@a.Id">
            <td class="dragHandle"></td>
            <td>
                @a.Text
            </td>
            <td>
                @a.IsCorrect
            </td>
            <td>
                @Ajax.ActionLink("Edit", "EditAnswer", "Quizzes", new { id = a.Id }, new AjaxOptions()
                {
                    InsertionMode = InsertionMode.Replace,
                    HttpMethod = "Get",
                    UpdateTargetId = "content",
                    OnSuccess = "applyValidation"

                })

            </td>
            <td>
                @Ajax.ActionLink("Delete", "DeleteAnswer", "Quizzes", new { id = a.Id, orderId = Model.Question.Answers.Count }, new AjaxOptions()
                {
                    InsertionMode = InsertionMode.Replace,
                    HttpMethod = "Get",
                    UpdateTargetId = "content",
                    OnSuccess = "applyValidation"

                })

            </td>
        </tr>

    }
                }
            </tbody>

        </table>

    </div>


}




<script>
    $(function () {


        $("#answersTbl").tableDnD({
            onDrop: function (table, row) {
                var rows = table.tBodies[0].rows;
                var ids = "";
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i] !== undefined) {
                        ids += rows[i].id + ",";
                    }
                }
                $("#Order").val(ids);
            }
        });

        $("#answersTbl tr").hover(function () {
            $(this.cells[0]).addClass('showDragHandle');
        }, function () {
            $(this.cells[0]).removeClass('showDragHandle');
        });



        $('#questionPoints').slider({
            formater: function (value) {
                return Math.round(value);
            }
        });

        $("#questionPoints").on('slide', function (slideEvt) {
            $("#Question_Points").attr("value", Math.round(slideEvt.value));
        });
    });
   
</script>


